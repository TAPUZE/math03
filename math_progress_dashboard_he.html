<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×”×”×ª×§×“××•×ª ×©×œ×™ | ×¤×œ×˜×¤×•×¨××ª ×œ××™×“×” ×‘××ª××˜×™×§×”</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif; 
        }
        /* Styles for printing: hide unnecessary elements */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none !important;
            }
        }
        #notification-box {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="notification-box" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-50 max-w-sm text-right">
        ×”×•×“×¢×” ×ª×•×¦×’ ×›××Ÿ
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8 no-print">
            <nav aria-label="breadcrumb" class="text-sm text-gray-600 mb-2">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="lessonchoicemenue.html" class="hover:underline">×“×£ ×¨××©×™</a> <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569-9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                    </li>
                    <li class="flex items-center">
                        <span class="text-gray-500">×”×”×ª×§×“××•×ª ×©×œ×™</span>
                    </li>
                </ol>
            </nav>
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700">×œ×•×— ×”×ª×§×“××•×ª ××™×©×™</h1>
        </header>

        <div id="print-area">
            <main class="bg-white p-6 md:p-8 rounded-lg shadow-lg">
                <section id="summary" aria-labelledby="summary-heading" class="mb-10">
                    <h2 id="summary-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">×¡×™×›×•× ×”×ª×§×“××•×ª</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-blue-50 p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-blue-800">×©×™×¢×•×¨×™× ×©×”×•×©×œ××•</h3>
                            <p id="total-lessons-completed" class="text-3xl font-bold text-blue-600 mt-2">0</p>
                        </div>
                        <div class="bg-green-50 p-6 rounded-lg shadow">
                            <h3 class="text-lg font-medium text-green-800">×××•×¦×¢ ×¦×™×•× ×™ ×‘×—× ×™×</h3>
                            <p id="average-quiz-score" class="text-3xl font-bold text-green-600 mt-2">×œ× ×–××™×Ÿ</p>
                        </div>
                    </div>
                </section>

                <section id="completed-lessons" aria-labelledby="completed-lessons-heading" class="mb-10">
                    <h2 id="completed-lessons-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">×©×™×¢×•×¨×™× ×©×”×•×©×œ××• âœ…</h2>
                    <div id="completed-lessons-list" class="space-y-3">
                        <p class="text-gray-500">×¢×“×™×™×Ÿ ×œ× ×”×©×œ××ª ×©×™×¢×•×¨×™×.</p>
                         </div>
                </section>

                <section id="quiz-scores" aria-labelledby="quiz-scores-heading" class="mb-10">
                    <h2 id="quiz-scores-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">×¦×™×•× ×™ ×‘×—× ×™× ğŸ¯</h2>
                    <div class="overflow-x-auto">
                        <table id="quiz-scores-table" class="min-w-full bg-white border border-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">×©× ×©×™×¢×•×¨</th>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">×¦×™×•×Ÿ</th>
                                    <th class="py-3 px-4 border-b text-right font-semibold text-gray-600">×ª××¨×™×š</th>
                                </tr>
                            </thead>
                            <tbody id="quiz-scores-tbody">
                                <tr><td colspan="3" class="text-center py-4 text-gray-500">×¢×“×™×™×Ÿ ××™×Ÿ ×¦×™×•× ×™ ×‘×—× ×™×.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </main>
        </div> 
        <section id="export-options" class="mt-8 mb-12 text-center no-print">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">××¤×©×¨×•×™×•×ª ×™×™×¦×•×</h2>
            <div class="space-x-0 md:space-x-4 space-y-4 md:space-y-0 rtl:space-x-reverse">
                <button id="export-pdf" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">
                    ×™×™×¦× ×›-PDF ğŸ“„
                </button>
                <button id="export-csv" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-md transition duration-150 ease-in-out">
                    ×™×™×¦× ×›-CSV ğŸ“Š
                </button>
            </div>
        </section>
        
        <footer class="text-center text-gray-600 mt-12 py-4 border-t border-gray-300 no-print">
            <p>&copy; <span id="current-year"></span> ×¤×œ×˜×¤×•×¨××ª ×œ××™×“×” ×‘××ª××˜×™×§×”. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.</p>
        </footer>
    </div>

    <script>
        // --- Notification Box Logic ---
        function showNotification(message, type = 'info', duration = 3000) {
            const notificationBox = document.getElementById('notification-box');
            if (!notificationBox) return;
            notificationBox.textContent = message;
            notificationBox.className = 'fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50 max-w-sm text-right'; 
            if (type === 'success') notificationBox.classList.add('bg-green-500');
            else if (type === 'error') notificationBox.classList.add('bg-red-500');
            else notificationBox.classList.add('bg-blue-500');
            notificationBox.classList.remove('hidden');
            notificationBox.style.opacity = 1;
            setTimeout(() => {
                notificationBox.style.opacity = 0;
                setTimeout(() => { notificationBox.classList.add('hidden'); }, 500);
            }, duration);
        }

        // --- Lesson ID to Display Name Mapping ---
        // This map MUST be kept up-to-date with all lesson IDs and their user-friendly names.
        const lessonDisplayNames = {
            // Shalon 35182
            '35182_algebra_linear_equation_one_variable': '××œ×’×‘×¨×” (35182): ××©×•×•××” ×××¢×œ×” ×¨××©×•× ×” ×¢× × ×¢×œ× ××—×“',
            '35182_algebra_linear_equations_two_variables': '××œ×’×‘×¨×” (35182): ××¢×¨×›×ª ××©×•×•××•×ª ×‘×©× ×™ × ×¢×œ××™×',
            '35182_algebra_quadratic_equations': '××œ×’×‘×¨×” (35182): ××©×•×•××•×ª ×¨×™×‘×•×¢×™×•×ª',
            '35182_algebra_inequalities': '××œ×’×‘×¨×” (35182): ××™-×©×•×•×™×•× ×•×ª',
            '35182_algebra_percentages': '××œ×’×‘×¨×” (35182): ××—×•×–×™×',
            '35182_algebra_word_problems': '××œ×’×‘×¨×” (35182): ×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª',
            '35182_geometry_shapes_properties': '×’×™××•××˜×¨×™×” (35182): ×ª×›×•× ×•×ª ×¦×•×¨×•×ª',
            '35182_geometry_area_perimeter': '×’×™××•××˜×¨×™×” (35182): ×©×˜×— ×•×”×™×§×£',
            '35182_analytic_geometry_points': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35182): × ×§×•×“×•×ª',
            '35182_analytic_geometry_distance': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35182): ××¨×—×§',
            '35182_analytic_geometry_midpoint': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35182): ×××¦×¢ ×§×˜×¢',
            '35182_analytic_geometry_slope_line_equation': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35182): ×©×™×¤×•×¢ ×•××©×•×•××ª ×”×™×©×¨',
            '35182_sequences_arithmetic_intro': '×¡×“×¨×•×ª (35182): ×¡×“×¨×” ×—×©×‘×•× ×™×ª - ××‘×•×',
            '35182_trigonometry_right_triangle': '×˜×¨×™×’×•× ×•××˜×¨×™×” (35182): ××©×•×œ×© ×™×©×¨ ×–×•×•×™×ª',
            '35182_statistics_intro': '×¡×˜×˜×™×¡×˜×™×§×” (35182): ××‘×•×',
            '35182_probability_intro': '×”×¡×ª×‘×¨×•×ª (35182): ××‘×•×',
            
            // Shalon 35381
            '35381_functions_parabola_investigation': '×¤×•× ×§×¦×™×•×ª (35381): ×—×§×™×¨×ª ×¤×•× ×§×¦×™×” ×¨×™×‘×•×¢×™×ª (×¤×¨×‘×•×œ×”)',
            '35381_sequences_arithmetic_sum': '×¡×“×¨×•×ª (35381): ×¡×›×•× ×¡×“×¨×” ×—×©×‘×•× ×™×ª',
            '35381_growth_decay': '×¤×•× ×§×¦×™×•×ª (35381): ×’×“×™×œ×” ×•×“×¢×™×›×”',
            '35381_statistics_dispersion': '×¡×˜×˜×™×¡×˜×™×§×” (35381): ××“×“×™ ×¤×™×–×•×¨',
            '35381_probability_tree_conditional': '×”×¡×ª×‘×¨×•×ª (35381): ×“×™××’×¨××ª ×¢×¥ ×•×”×¡×ª×‘×¨×•×ª ××•×ª× ×™×ª',
            '35381_normal_distribution': '×¡×˜×˜×™×¡×˜×™×§×” (35381): ×”×ª×¤×œ×’×•×ª × ×•×¨××œ×™×ª',
            '35381_trigonometry_plane': '×˜×¨×™×’×•× ×•××˜×¨×™×” (35381): ×˜×¨×™×’×•× ×•××˜×¨×™×” ×‘××™×©×•×¨ (×”××©×š)',
            
            // Shalon 35382
            'lesson_35382_problems_buy_sell': '×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª (35382): ×‘×¢×™×•×ª ×§× ×™×™×” ×•××›×™×¨×”', // Corrected ID prefix
            'lesson_35382_problems_motion': '×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª (35382): ×‘×¢×™×•×ª ×ª× ×•×¢×”',
            'lesson_35382_problems_work_rate': '×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª (35382): ×‘×¢×™×•×ª ×”×¡×¤×§',
            'lesson_35382_problems_geometric_algebraic': '×‘×¢×™×•×ª ××™×œ×•×œ×™×•×ª (35382): ×‘×¢×™×•×ª ×’×™××•××˜×¨×™×•×ª-××œ×’×‘×¨×™×•×ª',
            'lesson_35382_analytic_geometry_line_continued': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35382): ×”×™×©×¨ (×”××©×š)',
            'lesson_35382_analytic_geometry_circle': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35382): ×”××¢×’×œ',
            'lesson_35382_analytic_geometry_circle_tangent': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35382): ××©×™×§ ×œ××¢×’×œ',
            'lesson_35382_analytic_geometry_circle_line_intersection': '×’×™××•××˜×¨×™×” ×× ×œ×™×˜×™×ª (35382): ×—×™×ª×•×š ×©×œ ××¢×’×œ ×•×™×©×¨',
            'lesson_35382_calculus_polynomial': '×—×“×•"× (35382): ×¤×•× ×§×¦×™×™×ª ×¤×•×œ×™× ×•×',
            'lesson_35382_calculus_rational': '×—×“×•"× (35382): ×¤×•× ×§×¦×™×” ×¨×¦×™×•× ×œ×™×ª',
            'lesson_35382_calculus_square_root': '×—×“×•"× (35382): ×¤×•× ×§×¦×™×™×ª ×©×•×¨×©',
            'lesson_35382_calculus_optimization': '×—×“×•"× (35382): ×‘×¢×™×•×ª ×§×™×¦×•×Ÿ',
            'lesson_35382_calculus_integral_polynomial': '×—×“×•"× (35382): ×—×©×‘×•×Ÿ ××™× ×˜×’×¨×œ×™ (×¤×•×œ×™× ×•××™×)'
        };

        function formatLessonIdForDisplay(lessonIdKey) {
            // Remove prefixes like 'lesson_completed_' or 'lesson_quiz_score_'
            const idPart = lessonIdKey.replace(/^lesson_completed_|^lesson_quiz_score_/, '');
            return lessonDisplayNames[idPart] || idPart.replace(/_/g, ' ').replace(/^lesson /,''); // Fallback
        }

        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
            loadProgressData();
            const exportPdfButton = document.getElementById('export-pdf');
            if (exportPdfButton) exportPdfButton.addEventListener('click', exportToPdf);
            const exportCsvButton = document.getElementById('export-csv');
            if (exportCsvButton) exportCsvButton.addEventListener('click', exportToCsv);
        });

        function loadProgressData() {
            const completedLessonsList = document.getElementById('completed-lessons-list');
            const quizScoresTbody = document.getElementById('quiz-scores-tbody');
            const totalLessonsCompletedEl = document.getElementById('total-lessons-completed');
            const averageQuizScoreEl = document.getElementById('average-quiz-score');

            let completedLessons = [];
            let quizScores = [];

            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('lesson_completed_')) {
                        const lessonName = formatLessonIdForDisplay(key);
                        completedLessons.push(lessonName);
                    } else if (key.startsWith('lesson_quiz_score_')) {
                        const lessonName = formatLessonIdForDisplay(key);
                        const scoreDataString = localStorage.getItem(key);
                        if (scoreDataString) {
                            const scoreData = JSON.parse(scoreDataString);
                            quizScores.push({ 
                                name: lessonName, 
                                score: scoreData.score, 
                                total: scoreData.total, 
                                date: new Date(scoreData.date).toLocaleDateString('he-IL')
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Error reading from localStorage:", e);
                showNotification("×©×’×™××” ×‘×§×¨×™××ª × ×ª×•× ×™ ×”×ª×§×“××•×ª.", "error");
                if(completedLessonsList) completedLessonsList.innerHTML = '<p class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×©×™×¢×•×¨×™× ×©×”×•×©×œ××•.</p>';
                if(quizScoresTbody) quizScoresTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×¦×™×•× ×™ ×‘×—× ×™×.</td></tr>';
                return;
            }

            // Populate Completed Lessons
            if (completedLessonsList) {
                if (completedLessons.length > 0) {
                    completedLessonsList.innerHTML = ''; 
                    completedLessons.sort((a,b) => a.localeCompare(b, 'he')); 
                    completedLessons.forEach(lessonName => {
                        const lessonEl = document.createElement('div');
                        lessonEl.className = 'bg-gray-100 p-3 rounded-md shadow-sm flex items-center';
                        lessonEl.innerHTML = `<span class="text-green-500 mr-2 ml-2">âœ”</span> ${lessonName}`;
                        completedLessonsList.appendChild(lessonEl);
                    });
                } else {
                    completedLessonsList.innerHTML = '<p class="text-gray-500">×¢×“×™×™×Ÿ ×œ× ×”×©×œ××ª ×©×™×¢×•×¨×™×.</p>';
                }
            }
            if(totalLessonsCompletedEl) totalLessonsCompletedEl.textContent = completedLessons.length;

            // Populate Quiz Scores
            if (quizScoresTbody) {
                if (quizScores.length > 0) {
                    quizScoresTbody.innerHTML = ''; 
                    let totalScoreSum = 0;
                    let totalPossibleSum = 0;
                    quizScores.sort((a, b) => a.name.localeCompare(b.name, 'he')); 

                    quizScores.forEach(quiz => {
                        const row = quizScoresTbody.insertRow();
                        row.className = 'hover:bg-gray-50 transition-colors duration-150';
                        
                        const cellName = row.insertCell();
                        cellName.className = 'py-3 px-4 border-b text-right';
                        cellName.textContent = quiz.name;

                        const cellScore = row.insertCell();
                        cellScore.className = 'py-3 px-4 border-b text-right';
                        cellScore.textContent = `${quiz.score} / ${quiz.total}`;
                        
                        const cellDate = row.insertCell();
                        cellDate.className = 'py-3 px-4 border-b text-right';
                        cellDate.textContent = quiz.date;

                        if (typeof quiz.score === 'number' && typeof quiz.total === 'number' && quiz.total > 0) {
                            totalScoreSum += quiz.score;
                            totalPossibleSum += quiz.total;
                        }
                    });

                    if (averageQuizScoreEl) {
                        if (totalPossibleSum > 0) {
                            const average = (totalScoreSum / totalPossibleSum) * 100;
                            averageQuizScoreEl.textContent = `${average.toFixed(1)}%`;
                        } else {
                            averageQuizScoreEl.textContent = '×œ× ×–××™×Ÿ';
                        }
                    }

                } else {
                    quizScoresTbody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-gray-500">×¢×“×™×™×Ÿ ××™×Ÿ ×¦×™×•× ×™ ×‘×—× ×™×.</td></tr>';
                    if(averageQuizScoreEl) averageQuizScoreEl.textContent = '×œ× ×–××™×Ÿ';
                }
            }
        }

        function exportToPdf() {
            showNotification('××›×™×Ÿ PDF ×œ×”×“×¤×¡×”...', 'info', 2000);
            setTimeout(() => { window.print(); }, 500);
        }

        function getProgressDataForExport() {
            let completedLessons = [];
            let quizScoresData = [];
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith('lesson_completed_')) {
                        completedLessons.push(formatLessonIdForDisplay(key));
                    } else if (key.startsWith('lesson_quiz_score_')) {
                         const scoreDataString = localStorage.getItem(key);
                        if (scoreDataString) {
                            const scoreData = JSON.parse(scoreDataString);
                            quizScoresData.push({
                                name: formatLessonIdForDisplay(key),
                                score: scoreData.score,
                                total: scoreData.total,
                                date: new Date(scoreData.date).toLocaleDateString('he-IL')
                            });
                        }
                    }
                }
            } catch (e) {
                console.error("Error reading from localStorage for export:", e);
                showNotification("×©×’×™××” ×‘××™×¡×•×£ × ×ª×•× ×™× ×œ×™×™×¦×•×.", "error");
                return null;
            }
            completedLessons.sort((a,b) => a.localeCompare(b, 'he'));
            quizScoresData.sort((a, b) => a.name.localeCompare(b.name, 'he'));
            return { completedLessons, quizScoresData };
        }

        function exportToCsv() {
            const data = getProgressDataForExport();
            if (!data) return;

            const { completedLessons, quizScoresData } = data;
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "\uFEFF"; // BOM for UTF-8 Excel compatibility

            csvContent += "×¡×•×’,×¤×¨×˜,×¦×™×•×Ÿ,×¡×š ×”×›×œ ×©××œ×•×ª,×ª××¨×™×š\r\n";

            completedLessons.forEach(lessonName => {
                csvContent += `×©×™×¢×•×¨ ×”×•×©×œ×,"${lessonName.replace(/"/g, '""')}",,, \r\n`;
            });

            quizScoresData.forEach(quiz => {
                csvContent += `×¦×™×•×Ÿ ×‘×•×—×Ÿ,"${quiz.name.replace(/"/g, '""')}",${quiz.score},${quiz.total},${quiz.date}\r\n`;
            });
            
            if (completedLessons.length === 0 && quizScoresData.length === 0) {
                showNotification('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×.', 'info');
                return;
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "math_progress_report.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('×“×•×— CSV ×™×¨×“ ×‘×”×¦×œ×—×”!', 'success');
        }
    </script>
</body>
</html>
