<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLACEHOLDER_LESSON_TITLE | PLACEHOLDER_SUBJECT_AREA | PLACEHOLDER_BAGRUT_MODULE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css" integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js" integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8" crossorigin="anonymous"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js" integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Consider adding Google Font link if 'Inter' is not a system font */
        }
        .formula-box {
            background-color: #E5E7EB; /* Tailwind bg-gray-200 */
            padding: 0.75rem; /* Tailwind p-3 */
            border-radius: 0.375rem; /* Tailwind rounded-md */
            display: inline-block; 
            font-size: 1.125em; /* Tailwind text-lg */
            line-height: 1.5; 
        }
        .formula-box[dir="ltr"] .math-inline { text-align: left !important; }
        #notification-box {
            transition: opacity 0.5s ease-in-out;
        }
        /* Ensure KaTeX elements are sized appropriately if needed */
        .katex { font-size: 1.1em; } /* Example: Adjust KaTeX size */
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="notification-box" class="fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl hidden z-50 max-w-sm text-right">
        注 转爪 
    </div>

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <nav aria-label="breadcrumb" class="text-sm text-gray-600 mb-2">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a id="breadcrumb-menu-link" href="PLACEHOLDER_LESSON_CHOICE_MENU_FILENAME.html" class="text-blue-600 hover:underline">转驻专 专砖</a>
                    </li>
                    <li class="flex items-center">
                        <svg class="fill-current w-3 h-3 mx-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M285.476 272.971L91.132 467.314c-9.373 9.373-24.569 9.373-33.941 0l-22.667-22.667c-9.357-9.357-9.375-24.522-.04-33.901L188.505 256 34.484 101.255c-9.335-9.379-9.317-24.544.04-33.901l22.667-22.667c9.373-9.373 24.569 9.373 33.941 0L285.475 239.03c9.373 9.372 9.373 24.568.001 33.941z"/></svg>
                        <span id="breadcrumb-lesson-title" class="text-gray-500">PLACEHOLDER_LESSON_TITLE</span>
                    </li>
                </ol>
            </nav>
            <h1 id="lesson-title" class="text-3xl md:text-4xl font-bold text-blue-700">PLACEHOLDER_LESSON_TITLE</h1>
        </header>

        <!-- Lesson Selector Dropdown (for testing) -->
        <div id="lesson-selector-container" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg shadow">
            <label for="lesson-selector" class="block text-sm font-medium text-gray-700 mb-1">专 砖注专 注 (爪专 拽):</label>
            <select id="lesson-selector" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                <option value="">注 专砖转 砖注专...</option>
            </select>
        </div>
        <!-- End Lesson Selector Dropdown -->

        <main class="bg-white p-6 md:p-8 rounded-lg shadow-lg">

            <section id="learn" aria-labelledby="learn-heading" class="mb-12">
                <h2 id="learn-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2"> </h2>
                <div id="learning-content-container" class="space-y-6 text-gray-700 leading-relaxed">
                    <!-- Learning content will be injected here by JavaScript -->
                    <p>注 转 砖注专...</p>
                </div>
            </section>

            <section id="practice" aria-labelledby="practice-heading" class="mb-12">
                <h2 id="practice-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2">转专 锔</h2>
                <div id="exercises-container" class="space-y-8">
                    <!-- Exercises will be injected here by JavaScript -->
                </div>
            </section>

            <section id="test-yourself" aria-labelledby="test-heading" class="mb-12">
                <h2 id="test-heading" class="text-2xl font-semibold text-blue-600 mb-4 border-b-2 border-blue-200 pb-2"> 转 注爪 </h2>
                <div id="quiz-questions-container" class="space-y-6">
                    <!-- Quiz questions will be injected here by JavaScript -->
                </div>
                <button id="submit-quiz" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out mt-6">砖 </button>
                <div id="quiz-results" class="hidden mt-3 p-3 rounded-md text-sm"></div>
            </section>

            <!-- Lesson Completion Buttons -->
            <section id="lesson-completion-controls" class="mt-8 pt-6 border-t border-gray-200 text-center">
                <h3 class="text-xl font-semibold text-gray-700 mb-4">住住 砖注专</h3>
                <button id="mark-done" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out mr-2">
                    住 砖
                </button>
                <button id="mark-undone" class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-2 px-6 rounded-lg transition duration-150 ease-in-out" style="display: none;">
                    住  砖
                </button>
            </section>
            <!-- End Lesson Completion Buttons -->

            <!-- Hidden HTML Templates for Exercises and Quiz Questions -->
            <div id="html-templates" style="display: none;">
                <div id="exercise-template" class="exercise p-4 border border-gray-300 rounded-lg bg-gray-50">
                    <p class="exercise-question font-medium">转专 <span class="exercise-number"></span>: <span class="exercise-question-text"></span></p>
                    <div class="exercise-formula-container my-2 text-center" style="display: none;">
                        <span class="formula-box" dir="ltr"></span>
                    </div>
                    <p class="exercise-instructions"></p>
                    <div class="mt-3">
                        <input type="text" class="exercise-answer-input border border-gray-300 p-2 rounded w-full md:w-1/2 focus:ring-blue-500 focus:border-blue-500" placeholder="住 转砖">
                    </div>
                    <div class="mt-3">
                        <button class="check-answer-btn bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out">拽 转砖</button>
                        <button class="show-solution-btn bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition duration-150 ease-in-out ml-2">爪 驻转专</button>
                    </div>
                    <div class="feedback-container hidden mt-3 p-3 rounded-md text-sm"></div>
                    <div class="solution-container hidden mt-3 p-3 border-t border-gray-200 bg-white rounded-md">
                        <p><strong>驻转专 :</strong></p>
                        <div class="solution-content"></div>
                    </div>
                </div>

                <div id="quiz-question-template" class="quiz-question p-4 border border-gray-300 rounded-lg bg-gray-50">
                    <p class="font-medium">砖 <span class="quiz-question-number"></span>: <span class="quiz-question-text"></span></p>
                    <div class="quiz-formula-container my-2 text-center" style="display: none;">
                        <span class="formula-box" dir="ltr"></span>
                    </div>
                    <div class="quiz-options-container mt-2 space-y-1">
                        <!-- Options will be injected here -->
                    </div>
                </div>
            </div>
            <!-- End Hidden HTML Templates -->
        </main>

        <footer class="bg-gray-800 text-white text-center p-6 mt-12">
            <div class="container mx-auto">
                <p class="text-sm">&copy; <span id="current-year-footer"></span>  转 砖专转. 驻驻专转  转拽.</p>
                <p class="text-xs mt-1">驻转 住注 GitHub Copilot.</p>
            </div>
        </footer>
    </div>

    <script>
        // --- Determine Lesson ID from URL ---
        const urlParams = new URLSearchParams(window.location.search);
        const lessonIdFromUrl = urlParams.get('lesson');
        // Use the lesson ID from the URL, or a placeholder if not provided, which will trigger an error message.
        let LESSON_ID_SUFFIX = lessonIdFromUrl || null; 
        // --- End Determine Lesson ID ---

        const CONTENT_BASE_PATH = 'content/'; // Assuming JSON files are in a 'content' subdirectory

        // Global reference for lesson data once loaded
        let currentLessonData = null; 
        
        const STORAGE_KEY_COMPLETED = `lesson_completed_${LESSON_ID_SUFFIX}`;
        const STORAGE_KEY_QUIZ_SCORE = `lesson_quiz_score_${LESSON_ID_SUFFIX}`;
        const notificationBox = document.getElementById('notification-box');

        // --- Notification Functions (no change) ---
        function showNotification(message, type = 'info', duration = 3000) {
            if (!notificationBox) return;
            notificationBox.textContent = message;
            notificationBox.className = 'fixed top-5 right-5 text-white p-4 rounded-lg shadow-xl z-50 max-w-sm text-right'; 
            if (type === 'success') notificationBox.classList.add('bg-green-500');
            else if (type === 'error') notificationBox.classList.add('bg-red-500');
            else notificationBox.classList.add('bg-blue-500'); // Default to blue for 'info'
            notificationBox.classList.remove('hidden');
            notificationBox.style.opacity = 1;
            setTimeout(() => {
                notificationBox.style.opacity = 0;
                setTimeout(() => { notificationBox.classList.add('hidden'); }, 500);
            }, duration);
        }

        function markLessonAsCompleted() {
            try {
                localStorage.setItem(STORAGE_KEY_COMPLETED, 'true');
                updateButtonVisibility();
                showNotification('砖注专 砖专 砖!', 'success');
            } catch (e) {
                console.error('Error saving completion status to localStorage:', e);
                showNotification('砖 砖专转 住住 砖.', 'error');
            }
        }

        function markLessonAsNotCompleted() {
            try {
                localStorage.removeItem(STORAGE_KEY_COMPLETED);
                updateButtonVisibility();
                showNotification('住 砖注专  砖 .', 'info');
            } catch (e) {
                console.error('Error removing completion status from localStorage:', e);
                showNotification('砖  住住 砖.', 'error');
            }
        }

        function updateButtonVisibility() {
            const markDoneButton = document.getElementById('mark-done');
            const markUndoneButton = document.getElementById('mark-undone');
            if (!markDoneButton || !markUndoneButton) return;

            const isCompleted = localStorage.getItem(STORAGE_KEY_COMPLETED) === 'true';
            markDoneButton.style.display = isCompleted ? 'none' : 'inline-block';
            markUndoneButton.style.display = isCompleted ? 'inline-block' : 'none';
        }
        
        async function loadAndDisplayLessonContent(lessonIdToLoad) {
            LESSON_ID_SUFFIX = lessonIdToLoad; // Update global LESSON_ID_SUFFIX
            if (!LESSON_ID_SUFFIX || LESSON_ID_SUFFIX === 'PLACEHOLDER_MODULE_LESSONNAME') {
                showNotification('砖: 拽 砖注专 (LESSON_ID_SUFFIX)  专.  转 注 转.', 'error', 10000);
                document.getElementById('learning-content-container').innerHTML = '<p class="text-red-500">砖:  专 砖注专 注.  专 砖注专 专砖  注 砖注专 专 驻专专 URL (?lesson=YOUR_LESSON_ID).</p>';
                // Clear other dynamic parts of the page
                document.title = '注 砖注专';
                document.getElementById('breadcrumb-lesson-title').textContent = '注 砖注专';
                document.getElementById('lesson-title').textContent = '注 砖注专';
                document.getElementById('exercises-container').innerHTML = '';
                document.getElementById('quiz-questions-container').innerHTML = '';
                document.getElementById('quiz-results').classList.add('hidden');
                updateButtonVisibility(); // Update based on potentially null LESSON_ID_SUFFIX
                return;
            }

            // Update URL without reloading page, for bookmarking/sharing
            const newUrl = window.location.protocol + "//" + window.location.host + window.location.pathname + '?lesson=' + LESSON_ID_SUFFIX;
            window.history.pushState({path:newUrl}, '', newUrl);

            // Re-initialize storage keys based on the new LESSON_ID_SUFFIX
            window.STORAGE_KEY_COMPLETED = `lesson_completed_${LESSON_ID_SUFFIX}`;
            window.STORAGE_KEY_QUIZ_SCORE = `lesson_quiz_score_${LESSON_ID_SUFFIX}`;

            try {
                const response = await fetch(`${CONTENT_BASE_PATH}${LESSON_ID_SUFFIX}.json?v=${new Date().getTime()}`); // Cache buster
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - Could not load ${LESSON_ID_SUFFIX}.json`);
                }
                currentLessonData = await response.json();
                populatePage(currentLessonData);
            } catch (error) {
                console.error('Error loading lesson content:', error);
                showNotification(`砖 注转 转 砖注专: ${error.message}`, 'error', 10000);
                document.getElementById('learning-content-container').innerHTML = `<p class="text-red-500"> 转  注 转 转 砖注专. 拽 转 拽住 驻转 驻专 住驻  砖拽抓 -JSON (${LESSON_ID_SUFFIX}.json) 拽 转拽转 'content' 砖 转拽.</p>`;
            }
        }

        function populatePage(data) {
            // Page Title
            document.title = `${data.title} | ${data.subjectArea} | ${data.bagrutModule}`;

            // Breadcrumbs & Header Title
            document.getElementById('breadcrumb-menu-link').href = data.lessonChoiceMenuFilename;
            document.getElementById('breadcrumb-lesson-title').textContent = data.title;
            document.getElementById('lesson-title').textContent = data.title;

            // Learning Content
            const learningContainer = document.getElementById('learning-content-container');
            learningContainer.innerHTML = data.learningContentHtml || '<p> 爪 转 .</p>';

            // Exercises
            populateExercises(data.exercises || []);

            // Quiz
            populateQuiz(data.quiz ? data.quiz.questions || [] : []);
            
            // Navigation Links
            const nextLessonLink = document.getElementById('next-lesson-link');
            if (nextLessonLink) {
                if (data.nextLessonFilename && data.nextLessonTitle) {
                    nextLessonLink.href = data.nextLessonFilename;
                    nextLessonLink.innerHTML = `砖注专 : ${data.nextLessonTitle}`;
                    nextLessonLink.style.display = 'inline-block';
                } else {
                    nextLessonLink.style.display = 'none';
                }
            }
            const lessonChoiceMenuLink = document.getElementById('lesson-choice-menu-link');
            if (lessonChoiceMenuLink) {
                 lessonChoiceMenuLink.href = data.lessonChoiceMenuFilename || '#';
            }

            // Render Math with KaTeX AFTER all content is injected
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "\\[", right: "\\]", display: true},
                        {left: "\\(", right: "\\)", display: false},
                        {left: "$", right: "$", display: false}
                    ],
                    throwOnError: false
                });
            }
        }

        function populateExercises(exercisesData) {
            const container = document.getElementById('exercises-container');
            const template = document.getElementById('exercise-template');
            if (!container || !template) return;
            container.innerHTML = ''; // Clear existing

            exercisesData.forEach((exData, index) => {
                const exerciseEl = template.cloneNode(true);
                exerciseEl.id = `ex-${exData.id || index}`; // Unique ID for the exercise block

                exerciseEl.querySelector('.exercise-number').textContent = (index + 1);
                exerciseEl.querySelector('.exercise-question-text').innerHTML = exData.questionText; // Use innerHTML for KaTeX
                
                const formulaContainer = exerciseEl.querySelector('.exercise-formula-container');
                const formulaBox = formulaContainer.querySelector('.formula-box');
                if (exData.formula) {
                    formulaBox.innerHTML = exData.formula;
                    formulaContainer.style.display = 'block';
                } else {
                    formulaContainer.style.display = 'none';
                }

                exerciseEl.querySelector('.exercise-instructions').innerHTML = exData.instructions;
                
                const answerInput = exerciseEl.querySelector('.exercise-answer-input');
                answerInput.id = `ex-answer-${exData.id || index}`;
                answerInput.placeholder = exData.inputPlaceholder || '住 转砖';

                const feedbackEl = exerciseEl.querySelector('.feedback-container');
                feedbackEl.id = `feedback-ex-${exData.id || index}`;
                
                const solutionContainer = exerciseEl.querySelector('.solution-container');
                solutionContainer.id = `sol-${exData.id || index}`;
                solutionContainer.querySelector('.solution-content').innerHTML = exData.solutionHtml;

                const checkBtn = exerciseEl.querySelector('.check-answer-btn');
                checkBtn.id = `check-ex-${exData.id || index}-btn`;
                
                const showSolBtn = exerciseEl.querySelector('.show-solution-btn');
                showSolBtn.id = `show-sol-${exData.id || index}-btn`;

                container.appendChild(exerciseEl);
                setupExerciseEventListeners(exerciseEl, exData);
            });
        }

        function populateQuiz(questionsData) {
            const container = document.getElementById('quiz-questions-container');
            const template = document.getElementById('quiz-question-template');
            if (!container || !template) return;
            container.innerHTML = ''; // Clear existing

            questionsData.forEach((qData, index) => {
                const questionEl = template.cloneNode(true);
                questionEl.id = `quiz-q-${qData.id || index}`;

                questionEl.querySelector('.quiz-question-number').textContent = (index + 1);
                questionEl.querySelector('.quiz-question-text').innerHTML = qData.questionText;

                const formulaContainer = questionEl.querySelector('.quiz-formula-container');
                const formulaBox = formulaContainer.querySelector('.formula-box');
                if (qData.formula) {
                    formulaBox.innerHTML = qData.formula;
                    formulaContainer.style.display = 'block';
                } else {
                    formulaContainer.style.display = 'none';
                }

                const optionsContainer = questionEl.querySelector('.quiz-options-container');
                optionsContainer.innerHTML = ''; // Clear template options
                qData.options.forEach(opt => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center';
                    const input = document.createElement('input');
                    input.type = 'radio';
                    input.name = `q-${qData.id || index}`;
                    input.value = opt.value;
                    input.className = 'ml-2';
                    label.appendChild(input);
                    label.innerHTML += ` ${opt.text}`; // Append text, potentially with KaTeX
                    optionsContainer.appendChild(label);
                });
                container.appendChild(questionEl);
            });
        }


        // --- Populate Lesson Selector Dropdown ---
        async function populateLessonSelector() {
            const selector = document.getElementById('lesson-selector');
            if (!selector) return;

            try {
                const response = await fetch(`${CONTENT_BASE_PATH}lessons_manifest.json?v=${new Date().getTime()}`); // Corrected template literal
                if (!response.ok) {
                    throw new Error('Could not load lessons_manifest.json');
                }
                const lessons = await response.json();
                
                selector.innerHTML = '<option value="">专 砖注专...</option>'; // Clear loading message and add default
                lessons.forEach(lesson => {
                    const option = document.createElement('option');
                    option.value = lesson.id;
                    option.textContent = lesson.title;
                    if (lesson.id === LESSON_ID_SUFFIX) { // Pre-select if it matches current lesson
                        option.selected = true;
                    }
                    selector.appendChild(option);
                });

                selector.addEventListener('change', (event) => {
                    const selectedLessonId = event.target.value;
                    if (selectedLessonId) {
                        loadAndDisplayLessonContent(selectedLessonId);
                    }
                });

            } catch (error) {
                console.error('Error populating lesson selector:', error);
                selector.innerHTML = '<option value="">砖 注转 砖注专</option>';
                showNotification('砖 注转 专砖转 砖注专.', 'error');
            }
        }
        // --- End Populate Lesson Selector ---

        document.addEventListener('DOMContentLoaded', function () {
            // Set current year in footer
            const currentYearFooter = document.getElementById('current-year-footer');
            if (currentYearFooter) {
                currentYearFooter.textContent = new Date().getFullYear();
            }
            
            populateLessonSelector(); // Populate the dropdown first

            if (LESSON_ID_SUFFIX) { // If a lesson ID was found in URL
                loadAndDisplayLessonContent(LESSON_ID_SUFFIX); // Load content from JSON based on URL param
            } else {
                // If no lesson in URL, display a message or default state
                document.getElementById('learning-content-container').innerHTML = '<p class="text-blue-500"> 专 砖注专 专砖 注  转.</p>';
                updateButtonVisibility(); // Ensure buttons are in correct state
            }

            // Setup mark complete/incomplete buttons
            const markDoneButton = document.getElementById('mark-done');
            const markUndoneButton = document.getElementById('mark-undone');

            if (markDoneButton) markDoneButton.addEventListener('click', markLessonAsCompleted);
            if (markUndoneButton) markUndoneButton.addEventListener('click', markLessonAsNotCompleted);
            
            updateButtonVisibility(); // Initial state update for buttons

            // Quiz submit button listener
            const quizSubmitButton = document.getElementById('submit-quiz');
            if (quizSubmitButton) {
                quizSubmitButton.addEventListener('click', handleSubmitQuiz);
            }
        });

        // --- Helper Functions ---
        function normalizeSystemAnswer(answerString) {
            // Example: Cleans "(x,y)" to "x,y". Adapt if needed.
            if (typeof answerString !== 'string') return '';
            return answerString.replace(/[()\s]/g, '').toLowerCase();
        }

        function showSolution(solutionId) {
            const solutionEl = document.getElementById(solutionId); // solutionId is now like `sol-${exData.id}`
            if (solutionEl) {
                const isHidden = solutionEl.classList.toggle('hidden');
                // Re-render KaTeX if solution is shown and contains math
                if (!isHidden && typeof renderMathInElement === 'function') {
                    renderMathInElement(solutionEl, {
                         delimiters: [
                            {left: "$$", right: "$$", display: true},
                            {left: "\\[", right: "\\]", display: true},
                            {left: "\\(", right: "\\)", display: false},
                            {left: "$", right: "$", display: false} 
                        ],
                        throwOnError: false
                    });
                }
            }
        }
        
        // --- Exercise Specific Logic ---
        function setupExerciseEventListeners(exerciseElement, exerciseData) {
            const exerciseId = exerciseData.id || (Array.from(exerciseElement.parentNode.children).indexOf(exerciseElement)); // Fallback if id is missing
            const correctAnswer = normalizeSystemAnswer(exerciseData.correctAnswer);

            const answerInput = exerciseElement.querySelector('.exercise-answer-input');
            const feedbackEl = exerciseElement.querySelector('.feedback-container');
            const checkBtn = exerciseElement.querySelector('.check-answer-btn');
            const showSolBtn = exerciseElement.querySelector('.show-solution-btn');
            const solutionContainerId = `sol-${exerciseId}`;


            if (checkBtn && answerInput && feedbackEl) {
                checkBtn.addEventListener('click', () => {
                    const userAnswerNormalized = normalizeSystemAnswer(answerInput.value); 
                    if (userAnswerNormalized === correctAnswer) {
                        feedbackEl.textContent = ' !  ! ';
                        feedbackEl.className = 'feedback-container mt-3 p-3 rounded-md text-sm bg-green-100 text-green-700';
                    } else {
                        feedbackEl.textContent = '转砖 砖. 住 砖  爪 转 驻转专. ';
                        feedbackEl.className = 'feedback-container mt-3 p-3 rounded-md text-sm bg-red-100 text-red-700';
                    }
                    feedbackEl.classList.remove('hidden');
                });
            }

            if (showSolBtn) {
                showSolBtn.addEventListener('click', () => {
                    showSolution(solutionContainerId);
                });
            }
        }
        // --- End Exercise Specific Logic ---

        // --- Quiz Logic ---
        function handleSubmitQuiz() {
            if (!currentLessonData || !currentLessonData.quiz || !currentLessonData.quiz.questions) {
                showNotification("转   注 专.", "error");
                return;
            }

            let score = 0;
            const quizQuestions = currentLessonData.quiz.questions;
            const totalQuestions = quizQuestions.length;

            if (totalQuestions === 0) {
                showNotification(" 注  专 ( 砖转 转).", "info");
                return;
            }

            quizQuestions.forEach((qData, index) => {
                const questionId = qData.id || index;
                const userAnswerRadio = document.querySelector(`input[name="q-${questionId}"]:checked`);
                if (userAnswerRadio && userAnswerRadio.value === qData.correctAnswer) {
                    score++;
                }
            });
            
            const resultsEl = document.getElementById('quiz-results');
            if (resultsEl) {
                resultsEl.innerHTML = `爪 砖 : <strong>${score}</strong> 转 ${totalQuestions}.`;
                if (score / totalQuestions >= 0.8) { 
                    resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-green-100 text-green-700';
                } else if (score / totalQuestions >= 0.5) {
                    resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-yellow-100 text-yellow-700';
                } else { 
                    resultsEl.className = 'mt-3 p-3 rounded-md text-sm bg-red-100 text-red-700';
                }
                resultsEl.classList.remove('hidden');
            }
            
            recordQuizScore(LESSON_ID_SUFFIX, score, totalQuestions); // LESSON_ID_SUFFIX is global
            showNotification(` 砖! 爪: ${score}/${totalQuestions}`, 'info');
        }

        function recordQuizScore(lessonId, score, totalQuestions) { // lessonId is LESSON_ID_SUFFIX
            if (!lessonId || lessonId === 'PLACEHOLDER_MODULE_LESSONNAME') { 
                showNotification("砖:  转  转 转 砖注专 砖专转 爪 (ID 住专).", "error");
                return;
            }
            try {
                localStorage.setItem(STORAGE_KEY_QUIZ_SCORE, JSON.stringify({score, totalQuestions, date: new Date().toISOString()}));
            } catch (e) {
                console.error("Error accessing localStorage for quiz score:", e);
                showNotification("砖 砖专转 爪 .", "error");
            }
        }
    </script>
</body>
</html>
